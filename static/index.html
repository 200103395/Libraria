<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: antiquewhite;
            height: 100%;
        }
        .mainBlock {
            width: 100vw;
            overflow-x: auto;
            white-space: nowrap;
            margin: 20px 0 0 0;
        }
        #libraries {
            display: flex;
            overflow-x: auto;
            height: 30%;
        }
        .library {
            overflow-y: auto;
            border: 1px solid white;
            background: white;
            margin: 5px;
            border-radius: 5px;
            padding: 5px;
        }
        #books {
            display: flex;
            width: 100%;
            overflow-y: auto;
        }
        .book {
            width: 20vw;
            border: 1px solid white;
            background: white;
            margin: 5px;
            border-radius: 5px;
            padding: 5px;
        }
        .line {
            width: fit-content;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .book-container {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            margin: 0 20px 20px 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: inline-block;
            width: 400px;
        }
        .book-title {
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .book-author {
            overflow: hidden;
            text-overflow: ellipsis;
            font-style: italic;
            color: #555;
            margin-bottom: 10px;
        }
        .book-info {
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
            color: #333;
            margin-bottom: 10px;
        }
        .book-description {
            font-size: 14px;
            color: #777;
            margin-bottom: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            word-wrap: break-word;
            display: -webkit-box;
            -webkit-line-clamp: 3; /* Number of lines to show */
            -webkit-box-orient: vertical;
        }
        p {
            overflow-x: auto;
        }
    </style>
</head>
<body>
<include src="header.html"></include>
<h1>Main page</h1>
<br>
<div id="account"></div>
<div class="mainBlock">
<div id="books"></div>
    <br>
</div><div class="mainBlock">
<div id="libraries"></div>
</div>
<script>
    window.onload = function () {
        fetch('/getHeader').then(response => response.text())
            .then(html => {
                document.body.innerHTML = html + document.body.innerHTML;
                fetchAccount();
            }).catch(error => {
            console.error(error);
        });
        fetchBooks();
        fetchLibraries();
    }
</script>

<script>
    function confirmLogout() {
        let result = confirm("Are you sure you want to logout?");
        if(result) {
            window.location.href = '/unAuthorize';
        }
    }
    function fetchLibraries() {
        fetch('/getLibraries')
            .then(response => response.json())
            .then(data => showLibraries(data))
            .catch(error => console.error(error));
    }
    function fetchBooks() {
        fetch('/getSomeBooks')
            .then(response => response.json())
            .then(data => showBooks(data))
            .catch(error => console.error(error));
    }
    function showBooks(data) {
        if(data === null) {
            return;
        }
        let container = document.getElementById('books');
        data.forEach(jsonObject => {
            const div = document.createElement('div');
            const a = document.createElement('a');
            a.href = '/book/' + jsonObject['id'];
            a.style.textDecoration = 'none';
            a.style.color = 'inherit';
            div.className = 'book-container';/*
            Object.keys(jsonObject).forEach(key => {
                // Create a paragraph element for each key-value pair
                const paragraph = document.createElement('p');
                paragraph.textContent = `${key}: ${jsonObject[key]}`;
                div.appendChild(paragraph);
            });*/
            const title = document.createElement('div'); title.className = 'line book-title';
            const author = document.createElement('div'); author.className = 'line book-author';
            const info = document.createElement('div'); info.className = 'line book-info';
            const desc = document.createElement('div'); desc.className = 'book-description';
            title.innerText = jsonObject['name'];
            author.innerText = jsonObject['author'];
            let text = "Year: " + jsonObject['year'] + " | Genre: " + jsonObject['genre'] + " | Language: " + jsonObject['language'] + " | Pages " + jsonObject['pageNumber'];
            info.innerText = text;
            desc.innerText = jsonObject['description'];
            let width = title.style.width;
            if(author.style.width > width) {
                width = author.style.width;
            }
            if(info.style.width > width) {
                width = info.style.width;
            }
            desc.style.maxWidth = `${width}px`;
            if(jsonObject['description'].length > 500) {
                desc.innerText = jsonObject['description'].substring(0, 500) + '...';
            }
            if(desc.innerText == '') {
                desc.innerText = 'No description';
            }
            div.append(title, author, info, desc);

            a.appendChild(div);
            container.appendChild(a);
        });
    }
    function showLibraries(data) {
        let mainDiv = document.getElementById('libraries');
        data.forEach(function(line) {
            let block = document.createElement('div');
            block.className = 'library';
            const a = document.createElement('a');
            a.href = '/library/' + line['id'];
            a.style.textDecoration = 'none';
            a.style.color = 'inherit';

            let ul = document.createElement('ul');
            let name = document.createElement('li');
            let email = document.createElement('li');
            let address = document.createElement('li');
            let number = document.createElement('li');
            name.innerText = line['name'];
            email.innerText = line['email'];
            address.innerText = line['address'];
            number.innerText = line['contactNumber'];
            ul.append(name,email,address,number);
            block.appendChild(ul);
            a.appendChild(block);
            mainDiv.appendChild(a);
        });
    }
    function fetchAccount() {
        let account;
        fetch('/getAuth').then(response => response.json())
            .then(data => {
                let obj = document.getElementById('header');
                account = data;
                if( data.hasOwnProperty('error')) {
                    console.log("Has error");
                    let login = document.createElement("span");
                    let linkAcc = document.createElement("a");
                    linkAcc.href = "/login";
                    linkAcc.innerText = "Login";
                    login.appendChild(linkAcc);
                    login.style.marginLeft = '10px';
                    obj.appendChild(login);

                    var register = document.createElement("span");
                    var linkLib = document.createElement("a");
                    linkLib.href = "/register";
                    linkLib.innerText = "Register";
                    register.appendChild(linkLib);
                    register.style.marginLeft = '10px';
                    obj.appendChild(register);
                } else {
                    console.log("Doesn't have error", JSON.stringify(data));
                    var name = document.createElement("span");
                    name.style.marginLeft = '10px';
                    var link = document.createElement("a");
                    if(account.hasOwnProperty('firstName')) {
                        link.href = "account/" + account.id;
                        link.innerText = account.firstName + ' ' + account.lastName;
                    } else {
                        link.href = "library/" + account.id;
                        link.innerText = account.name;
                    }
                    name.appendChild(link);
                    obj.appendChild(name);
                    var signout = document.createElement("span");
                    signout.style.marginLeft = '15px';
                    var outlink = document.createElement('button');
                    outlink.addEventListener("click", confirmLogout);
                    outlink.innerText = 'Sign Out';
                    signout.appendChild(outlink);
                    obj.appendChild(signout);
                }
            })
            .catch(error => {
                console.error('Error fetching account information: ', error);
            });
        console.log(account);
    }
</script>
</body>
</html>