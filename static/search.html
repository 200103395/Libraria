<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script>
      let books;
      let libs;
      var libsSet = {};
      function sendData() {
          let input = document.getElementById("inputField").value;
          let data = JSON.stringify({"inputValue": input});
          fetch("/search", {
              method: "POST",
              headers: {
                  "Content-type": "application/json"
              },
              body: data
          }).then(response => response.json())
              .then(data => {
                  if( !data.hasOwnProperty('error')) {
                      books = data['books'];
                      libs = data['libraries'];
                  }
                  populateData();
              }).catch(error => console.error(error));
      }

      function populateData() {
          //TODO: something
          populateFilter();
          showBooks(books);
      }
      function showBooks(data) {
          let container = document.getElementById('containerDiv');
          container.innerHTML = '';
          data.forEach(jsonObject => {
              const div = document.createElement('div');
              div.className = 'book';
              const a = document.createElement('a');
              a.href = '/book/' + jsonObject['id'];
              a.style.textDecoration = 'none';
              a.style.color = 'inherit';
              Object.keys(jsonObject).forEach(key => {
                  const paragraph = document.createElement('p');
                  paragraph.textContent = `${key}: ${jsonObject[key]}`;
                  div.appendChild(paragraph);
              });
              a.appendChild(div);
              container.appendChild(a);
          });
      }
      function clear(name, selName, array) {
          let selection = document.getElementById(name);
          selection.innerHTML = '';
          let def = document.createElement('option');
          def.text = 'Select ' + selName;
          def.value = '';
          selection.appendChild(def);
          array.forEach(function(element) {
              let option = document.createElement('option');
              option.value = element;
              option.text = element;
              selection.appendChild(option);
          });
      }
      function populateFilter() {
          let years = [];
          let langs = [];
          let genres = [];
          books.forEach(jsonObject => {
              if( !years.includes(jsonObject['year'])) {
                  years.push(jsonObject['year']);
              }
              if( !langs.includes(jsonObject['language'])) {
                  langs.push(jsonObject['language']);
              }
              if( !genres.includes(jsonObject['genre'])) {
                  genres.push(jsonObject['genre']);
              }
          });
          years.sort(function(a,b) {
              return a - b;
          });
          clear('year', 'Year', years);
          clear('language', 'Language', langs);
          clear('genre', 'Genre', genres);
          clear('library', 'Library', []);
          let librarySelection = document.getElementById('library');
          if(libs) {
              libs.forEach(function (lib) {
                  let option = document.createElement('option');
                  option.value = lib['id'];
                  option.text = lib['name'];
                  librarySelection.appendChild(option);
              });
          }
          fetchLibs();
          addListener();
      }
      var libDict = {};
      function addLibDict(id, data) {
          //console.log(data);
          if( data.hasOwnProperty('error')) {
              return;
          }
          libDict[id] = [];
          data.forEach(function(lib) {
              libDict[id].push(lib['id']);
          });
      }
      async function fetchLibs() {
          libDict = {};
          books.forEach(function(row) {
              fetch('/getLibrariesByBook/' + row['id'])
                  .then(response => response.json())
                  .then(libsData => addLibDict(row['id'], libsData))
                  .catch(error => console.error(error));
          });
      }
      function filter() {
          let year = document.getElementById('year').value;
          let lang = document.getElementById('language').value;
          let genre = document.getElementById('genre').value;
          let lib = document.getElementById('library').value;
          let valid = books.filter(function (book) {
              if( year != '' && book.year != year) {
                  return false;
              }
              if( lang != '' && book.language != lang) {
                  return false;
              }
              if( genre != '' && book.genre != genre) {
                  return false;
              }
              if( lib != '' && libDict[book['id']] && !libDict[book['id']].includes(parseInt(lib))) {
                  return false
              }
              return true;
          });
          showBooks(valid);
      }
      function addListener() {
          document.getElementById('filter').addEventListener("change", function() {
              filter();
          });
      }
    </script>
    <style>
        .book {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<h3>Type name or author</h3>
<input type="text" id="inputField">
<button onclick="sendData()">Search</button><br><br>
<form id="filter">
    <select id="year">
        <option value="">Select Year</option>
    </select>
    <select id="language">
        <option value="">Select Language</option>
    </select>
    <select id="genre">
        <option value="">Select Genre</option>
    </select>
    <select id="library">
        <option value="">Select Library</option>
    </select>
</form><button onclick="filter()">Filter</button><br><br>
<div id="containerDiv"></div>
</body>
</html>